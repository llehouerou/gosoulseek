# Task 4.2: Upload Request Handling - Design Document

## Overview

Implement handling of incoming upload requests from peers. When a peer sends a `QueueDownload` message requesting a file, we validate, queue, and respond appropriately.

## Dependencies

- **Task 4.1 (File Sharing)**: ✅ Complete - `FileSharer` provides file lookup
- **Task 1.3 (Transfer Manager)**: ✅ Complete - `TransferRegistry` tracks transfers
- **Task 3.2 (Queue Management)**: ✅ Complete - `QueueManager` tracks queue positions

## Design Decisions

1. **Flexible validation**: Optional `UploadValidator` callback for custom access control
2. **Default behavior**: Accept if file exists in `FileSharer`
3. **Duplicate handling**: Re-requests update queue position, don't create new transfer

## Components

### 1. UploadValidator Type (options.go)

```go
// UploadValidator validates incoming upload requests.
// Called when a peer sends QueueDownload requesting a file from us.
// Return nil to accept, or an error to reject with the error message sent to peer.
type UploadValidator func(username, filename string) error
```

Add to `Options` struct:
```go
UploadValidator UploadValidator
```

### 2. Handler Functions (upload_request.go)

#### handleQueueDownload

```go
func (c *Client) handleQueueDownload(payload []byte, username string, conn *connection.Conn)
```

Flow:
1. Decode `QueueDownload` message
2. Check `FileSharer` is configured and file exists
3. Call `UploadValidator` if configured
4. Check for existing transfer (duplicate detection)
5. Register new upload in `TransferRegistry` (or update existing)
6. Enqueue in `QueueManager`
7. Send `PlaceInQueueResponse`

#### sendUploadDenied

```go
func (c *Client) sendUploadDenied(conn *connection.Conn, filename, reason string) error
```

Encodes and sends `UploadDenied` message.

#### sendPlaceInQueueResponse

```go
func (c *Client) sendPlaceInQueueResponse(conn *connection.Conn, filename string, position uint32) error
```

Encodes and sends `PlaceInQueueResponse` message.

### 3. Integration (client.go)

Add case in `handleIncomingPeerMessages`:
```go
case uint32(protocol.PeerQueueDownload):
    c.handleQueueDownload(payload, username, conn)
```

## Request Flow

```
Peer                           Us
 │                              │
 │──QueueDownload(filename)────▶│
 │                              │
 │                    ┌─────────┴─────────┐
 │                    │ Validate:         │
 │                    │ 1. FileSharer     │
 │                    │ 2. UploadValidator│
 │                    └─────────┬─────────┘
 │                              │
 │                         valid?
 │                        /      \
 │                      no        yes
 │                      │          │
 │◀──UploadDenied───────┘          │
 │                           ┌─────┴─────┐
 │                           │ Register  │
 │                           │ & Enqueue │
 │                           └─────┬─────┘
 │                                 │
 │◀──PlaceInQueueResponse──────────┘
 │                                 │
```

## Test Plan

### Unit Tests (upload_request_test.go)

| Test Case | Setup | Expected |
|-----------|-------|----------|
| Accept valid file | FileSharer with file | Transfer registered, PlaceInQueueResponse sent |
| Reject unshared file | FileSharer without file | UploadDenied "File not shared" |
| Reject no FileSharer | FileSharer is nil | UploadDenied "File not shared" |
| Custom validator accepts | Validator returns nil | Transfer registered |
| Custom validator rejects | Validator returns error | UploadDenied with error message |
| Duplicate request | Existing transfer for user+file | Queue position updated, no new transfer |

### Test Utilities

- Mock connection using `net.Pipe()`
- Helper to read response messages from connection
- Helper to create test FileSharer with files

## Files to Create/Modify

### New Files
- `client/upload_request.go` - Handler implementation
- `client/upload_request_test.go` - Tests

### Modified Files
- `client/options.go` - Add `UploadValidator` type and field
- `client/client.go` - Register handler in message dispatch

## Implementation Order

1. Add `UploadValidator` to options.go
2. Create upload_request.go with handler functions
3. Add handler registration in client.go
4. Write tests in upload_request_test.go
5. Run `make check` to validate
